name: CI/CD to AKS

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set Azure subscription
      run: |
        # Extract subscription ID from AZURE_CREDENTIALS if needed
        SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.subscriptionId // empty')
        if [ -n "$SUBSCRIPTION_ID" ]; then
          az account set --subscription "$SUBSCRIPTION_ID"
        fi
        echo "Current Azure subscription:"
        az account show --output table
        echo ""
        echo "Available resource groups:"
        az group list --query "[].{Name:name, Location:location}" --output table

    # Derive ACR_NAME and keep login server from secret
    - name: Resolve ACR name
      id: acr
      run: |
        ACR_LOGIN_SERVER="${{ secrets.AZURE_CONTAINER_REGISTRY }}"   # e.g. oluwaseunportfoliodevacr.azurecr.io
        ACR_NAME="$(echo "$ACR_LOGIN_SERVER" | cut -d. -f1)"
        echo "ACR_LOGIN_SERVER=$ACR_LOGIN_SERVER" >> $GITHUB_ENV
        echo "ACR_NAME=$ACR_NAME" >> $GITHUB_ENV

    - name: Login to ACR
      run: az acr login --name "$ACR_NAME"

    - name: Build image
      run: |
        IMAGE="${{ env.ACR_LOGIN_SERVER }}/oluwaseun-portfolio-app:${{ github.sha }}"
        echo "IMAGE=$IMAGE" >> $GITHUB_ENV
        docker build -t "$IMAGE" .

    - name: Push image
      run: docker push "${{ env.IMAGE }}"

    - name: Verify AKS cluster exists
      run: |
        echo "Checking AKS cluster: ${{ secrets.AZURE_AKS_CLUSTER }} in resource group: ${{ secrets.AZURE_RESOURCE_GROUP }}"
        az aks show \
          --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
          --name "${{ secrets.AZURE_AKS_CLUSTER }}" \
          --query "{Name:name, ResourceGroup:resourceGroup, Status:provisioningState}" \
          --output table

    - name: Get AKS credentials
      run: |
        az aks get-credentials \
          --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
          --name "${{ secrets.AZURE_AKS_CLUSTER }}" \
          --overwrite-existing \
          --format azure
        kubectl get nodes

    - name: Roll out new image
      run: |
        kubectl set image deployment/oluwaseun-portfolio web="${{ env.IMAGE }}"
        kubectl rollout status deployment/oluwaseun-portfolio
