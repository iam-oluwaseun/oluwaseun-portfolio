name: Security Scans & Email Alert

on:
  workflow_run:
    workflows: ["CI/CD to AKS"]
    types: [completed]

jobs:
  security-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Resolve ACR name & login server from secret
      - name: Resolve ACR name
        id: acr
        run: |
          ACR_LOGIN_SERVER="${{ secrets.AZURE_CONTAINER_REGISTRY }}"   # e.g. oluwaseunportfoliodevacr.azurecr.io
          ACR_NAME="$(echo "$ACR_LOGIN_SERVER" | cut -d. -f1)"
          echo "ACR_LOGIN_SERVER=$ACR_LOGIN_SERVER" >> $GITHUB_ENV
          echo "ACR_NAME=$ACR_NAME" >> $GITHUB_ENV

      - name: ACR login
        run: az acr login --name "$ACR_NAME"

      - name: Run Trivy vulnerability scanner (image)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ env.ACR_LOGIN_SERVER }}/oluwaseun-portfolio:${{ github.sha }}
          format: 'table'
          vuln-type: 'os,library'
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true
          exit-code: '0'   # change to '1' if you want the workflow to FAIL on vulns

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: .
          args: >-
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "‚úÖ Security Scan Completed for oluwaseun-portfolio"
          to: oluwaseunopebiyi@gmail.com
          from: oluwaseunopebiyi@gmail.com
          body: |
            ‚úÖ Trivy and SonarCloud scans completed successfully for commit: ${{ github.sha }}

            üîç Trivy scanned image:
                ${{ env.ACR_LOGIN_SERVER }}/oluwaseun-portfolio:${{ github.sha }}

            üîé SonarCloud project:
                https://sonarcloud.io/project/overview?id=${{ secrets.SONAR_PROJECT_KEY }}
