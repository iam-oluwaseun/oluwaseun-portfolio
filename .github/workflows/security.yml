name: Security Scans & Email Alert

on:
  workflow_run:
    workflows: ["CI/CD to AKS"]
    types: [completed]

jobs:
  security-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Trivy filesystem scan (no ACR / Docker needed)
      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          input: .
          format: 'table'
          vuln-type: 'os,library'
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true
          exit-code: '0'   # change to '1' if you want the workflow to FAIL on vulns

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: .
          args: >-
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "‚úÖ Security Scan Completed for oluwaseun-portfolio"
          to: oluwaseunopebiyi@gmail.com
          from: oluwaseunopebiyi@gmail.com
          body: |
            ‚úÖ Trivy (filesystem) and SonarCloud scans completed successfully for commit: ${{ github.sha }}

            üîç Trivy scanned the repository files (Dockerfile, dependencies, etc.)

            üîé SonarCloud project:
                https://sonarcloud.io/project/overview?id=${{ secrets.SONAR_PROJECT_KEY }}
